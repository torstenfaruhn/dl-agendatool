<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8" />
    <title>DL Agendatool</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<header class="hero">
    <!-- Hero-achtergrond -->
    <img
        src="{{ url_for('static', filename='UitTipsLimburg.png') }}"
        alt="UitTipsLimburg achtergrond"
        class="hero__img"
    />

    <!-- Donkere overlay zodat tekst leesbaar blijft -->
    <div class="hero__overlay"></div>

    <!-- Logo -->
    <img
        src="{{ url_for('static', filename='logo.png') }}"
        alt="De Limburger"
        class="hero__logo"
    />

    <!-- Titel + subtitel -->
    <div class="hero__content">
        <h1>Maak snel je agenda-export</h1>
        <p>Upload je XML-agenda en kopieer of download direct de geconverteerde tekst.</p>
    </div>
</header>

<main class="container">
    <section class="card">
        <h2>Agendatool</h2>
        <p class="card__intro">
            Upload het XML-bestand uit je planningssysteem. Klik daarna op
            <strong>Maak agenda-export (.txt)</strong>. Je krijgt een tekstbestand dat je
            direct kunt gebruiken voor UitTipsLimburg.nl.
        </p>

        {% if error %}
        <p class="error">{{ error }}</p>
        {% endif %}

        <form method="post" enctype="multipart/form-data">
            <!-- Eerste rij: bestand kiezen + actieknop -->
            <div class="button-row">
                <label class="file btn-equal" id="file-label">
                    <span class="file__label" id="file-label-text">Bestand kiezen</span>
                    <input
                        type="file"
                        id="xml_file"
                        name="xml_file"
                        accept=".xml"
                    />
                </label>

                <button type="submit"
                        class="btn btn-primary btn-equal{% if output_text %} btn-success{% endif %}"
                        id="export-btn">
                    {% if output_text %}
                        Export geslaagd!
                    {% else %}
                        Maak agenda-export (.txt)
                    {% endif %}
                </button>
            </div>

            {% if output_text %}
            <!-- Tweede rij: download + kopieer -->
            <div class="button-row button-row--secondary">
                <button type="button" class="btn btn-secondary btn-equal" id="download-btn">
                    Download resultaat (.txt)
                </button>
                <button type="button" class="btn btn-secondary btn-equal" id="copy-btn">
                    Kopieer direct de code
                </button>
            </div>

            <!-- Verborgen tekstvak voor de gegenereerde code (nodig voor kopiëren/downloaden) -->
            <textarea id="result-text" class="visually-hidden" readonly>{{ output_text }}</textarea>
            {% endif %}
        </form>
    </section>
</main>

<footer class="footer">
    &copy; DL/MHNL 2025
</footer>

<!-- Snackbar -->
<div id="snackbar"></div>

<script>
    // ---------------- Dark mode op basis van CET-tijd ----------------
    (function () {
        try {
            const now = new Date();
            const cetHour = Number(
                new Intl.DateTimeFormat('nl-NL', {
                    hour: 'numeric',
                    hour12: false,
                    timeZone: 'Europe/Amsterdam'
                }).format(now)
            );
            if (cetHour >= 17) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        } catch (e) {
            // Fallback: gebruik lokale tijd als Intl/timeZone niet werkt
            const localHour = new Date().getHours();
            if (localHour >= 17) {
                document.body.classList.add('dark-mode');
            }
        }
    })();

    // ---------------- Huidige interactieve logica ----------------

    const fileInput = document.getElementById('xml_file');
    const fileLabel = document.getElementById('file-label');
    const fileLabelText = document.getElementById('file-label-text');

    const exportBtn = document.getElementById('export-btn');
    const copyBtn = document.getElementById('copy-btn');
    const downloadBtn = document.getElementById('download-btn');
    const resultText = document.getElementById('result-text');

    const successClass = 'btn-success';

    // Oorspronkelijke teksten
    const originalTexts = {
        export: "Maak agenda-export (.txt)",
        download: "Download resultaat (.txt)",
        copy: "Kopieer direct de code"
    };

    // Succes-teksten
    const successTexts = {
        export: "Export geslaagd!",
        download: "Resultaat gedownload!",
        copy: "Code gekopieerd!"
    };

    function clearAllSuccess() {
        [exportBtn, downloadBtn, copyBtn, fileLabel].forEach(el => {
            if (el) el.classList.remove(successClass);
        });
        if (exportBtn) exportBtn.textContent = originalTexts.export;
        if (downloadBtn) downloadBtn.textContent = originalTexts.download;
        if (copyBtn) copyBtn.textContent = originalTexts.copy;
    }

    function markSuccess(button) {
        if (!button) return;
        button.classList.add(successClass);
    }

    function showSnackbar(message) {
        const bar = document.getElementById('snackbar');
        if (!bar) return;

        bar.textContent = message;
        bar.classList.add('show');

        if (bar._hideTimeout) {
            clearTimeout(bar._hideTimeout);
        }
        bar._hideTimeout = setTimeout(() => {
            bar.classList.remove('show');
        }, 2500);
    }

    // Nieuw bestand gekozen -> alles resetten, file-knop groen maken
    if (fileInput && fileLabel && fileLabelText) {
        fileInput.addEventListener('change', () => {
            clearAllSuccess();

            if (fileInput.files.length) {
                const name = fileInput.files[0].name;
                fileLabel.classList.add('file--selected');
                fileLabelText.textContent = name;

                // File label wordt groen (actie geslaagd)
                markSuccess(fileLabel);
            } else {
                fileLabel.classList.remove('file--selected');
                fileLabel.classList.remove(successClass);
                fileLabelText.textContent = 'Bestand kiezen';
            }
        });
    }

    // Export-knop: file-label direct terug naar wit
    if (exportBtn && fileLabel) {
        exportBtn.addEventListener('click', () => {
            fileLabel.classList.remove(successClass);
            // Tekst/groen voor export wordt na POST door server+Jinja gezet
        });
    }

    // Als er output is (resultText bestaat), eenmalig snackbar voor export
    if (resultText) {
        showSnackbar("✔ " + successTexts.export);
    }

    // Download: knop groen + tekst wijzigen + snackbar
    if (downloadBtn && resultText) {
        downloadBtn.addEventListener('click', () => {
            const blob = new Blob([resultText.value], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'agenda_export.txt';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);

            markSuccess(downloadBtn);
            downloadBtn.textContent = successTexts.download;
            showSnackbar("✔ " + successTexts.download);
        });
    }

    // Kopieer: knop groen + tekst wijzigen + snackbar
    if (copyBtn && resultText) {
        copyBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(resultText.value);
                markSuccess(copyBtn);
                copyBtn.textContent = successTexts.copy;
                showSnackbar("✔ " + successTexts.copy);
            } catch (e) {
                alert('Kopiëren is niet gelukt. Probeer handmatig te kopiëren.');
            }
        });
    }
</script>

</body>
</html>
